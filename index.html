<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mori Pics 链接转换器</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0f172a;
      --card: #111827;
      --muted: #94a3b8;
      --accent: #60a5fa;
      --text: #e2e8f0;
      --border: #1f2937;
      font-family: "Inter", "PingFang SC", "Segoe UI", system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(96,165,250,0.08), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(125,211,252,0.12), transparent 30%),
                  var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 20px 48px;
    }

    。container {
      width: min(960px, 100%);
      background: rgba(17,24,39,0.7);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 28px 24px;
      box-shadow: 0 20px 70px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 18px;
      align-items: flex-start;
    }

    .title {
      font-size: 26px;
      font-weight: 700;
      margin: 0;
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
      max-width: 640px;
      line-height: 1.6;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      font-size: 13px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    form {
      display: grid;
      gap: 16px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      margin-top: 4px;
      line-height: 1.5;
    }

    input, textarea, button {
      width: 100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.8);
      color: var(--text);
      padding: 12px 14px;
      font-size: 15px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: rgba(96,165,250,0.8);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.25);
    }

    textarea { resize: vertical; min-height: 104px; }

    button.convert {
      background: linear-gradient(135deg, #60a5fa, #a78bfa);
      border: none;
      color: #0b1021;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(96,165,250,0.35);
    }

    .output-card {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      background: rgba(15,23,42,0.6);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .output-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .output-text {
      flex: 1;
      word-break: break-all;
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: rgba(255,255,255,0.03);
      min-height: 48px;
    }

    .copy-btn {
      width: auto;
      padding: 10px 14px;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: transform 0.1s ease;
    }

    .copy-btn:active { transform: translateY(1px); }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.06);
      border-radius: 12px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
    }

    .footer { margin-top: 12px; color: var(--muted); font-size: 13px; }

    @media (max-width: 720px) {
      .container { padding: 22px 18px; }
      .title { font-size: 22px; }
    }
  </style>
</head>
<body>
  <main class="container">
    <div class="header">
      <div>
        <h1 class="title">Mori Pics 链接转换器</h1>
        <p class="subtitle">将 Alist / R2 生成的临时签名链接秒变自定义域名直链，方便外部引用或分享。默认输出 <code>https://mori-pics.suimori.com</code>，也可以随时改成你的其他域名。</p>
      </div>
      <div class="pill" title="可以直接部署到 Cloudflare Pages 或任意静态主机">静态页面 · Cloudflare Pages 友好</div>
    </div>

    <form id="convert-form">
      <div>
        <label for="source">源链接（Alist / R2 / 其他带签名的直链）</label>
        <textarea id="source" placeholder="粘贴原始链接..." required></textarea>
        <p class="hint">支持带查询参数的签名链接，自动提取文件名。若有带 <code>response-content-disposition</code> 的文件名，也会优先使用。</p>
      </div>

      <div>
        <label for="output-domain">输出基础域名或完整前缀</label>
        <input id="output-domain" type="text" placeholder="https://mori-pics.suimori.com" value="https://mori-pics.suimori.com" />
        <p class="hint">可以是域名（自动补上 <code>https://</code>）或自定义前缀（例如 <code>https://img.example.com/pics</code>）。此配置会保存在浏览器本地。</p>
      </div>

      <div>
        <label for="alist-domain">Alist/入口域名（可选，纯记录方便日后切换）</label>
        <input id="alist-domain" type="text" placeholder="https://yume.suimori.com" value="https://yume.suimori.com" />
        <p class="hint">不会影响转换结果，只是方便预留和记录当前使用的存储入口域名，后续切换可以随时修改。</p>
      </div>

      <button class="convert" type="submit">转换为直链</button>
    </form>

    <div class="output-card" aria-live="polite">
      <div class="output-row">
        <div class="badge">转换结果</div>
        <button class="copy-btn" type="button" id="copy-btn">复制</button>
      </div>
      <div class="output-text" id="output">等待输入…</div>
    </div>

    <p class="footer">提示：这是纯前端页面，直接丢给 Cloudflare Pages、GitHub Pages 等静态托管即可，无需后端。</p>
  </main>

  <script>
    const form = document.getElementById('convert-form');
    const sourceEl = document.getElementById('source');
    const outputDomainEl = document.getElementById('output-domain');
    const alistEl = document.getElementById('alist-domain');
    const outputEl = document.getElementById('output');
    const copyBtn = document.getElementById('copy-btn');

    const STORAGE_KEY = 'mori-pics-settings';

    const loadSettings = () => {
      try {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        if (data.outputDomain) outputDomainEl.value = data.outputDomain;
        if (data.alistDomain) alistEl.value = data.alistDomain;
      } catch (err) {
        console.warn('Failed to load saved settings', err);
      }
    };

    const persistSettings = () => {
      const payload = {
        outputDomain: outputDomainEl.value.trim(),
        alistDomain: alistEl.value.trim(),
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    };

    const normalizeBase = (base) => {
      if (!base) return '';
      let clean = base.trim();
      if (!/^https?:\/\//i.test(clean)) {
        clean = 'https://' + clean;
      }
      // remove trailing slash to avoid double slashes when concatenating
      return clean.replace(/\/+$/, '');
    };

    const pickFileName = (urlObj) => {
      // 1. try response-content-disposition filename*
      const cd = urlObj.searchParams.get('response-content-disposition');
      if (cd) {
        const match = /filename\*?=([^;]+)/i.exec(cd);
        if (match) {
          const raw = match[1].trim().replace(/^UTF-8''/i, '');
          try { return decodeURIComponent(raw); } catch { return raw; }
        }
      }

      // 2. try common query fields
      const candidates = ['filename', 'attname', 'response-content-disposition'];
      for (const key of candidates) {
        const val = urlObj.searchParams.get(key);
        if (val) return val.split(';')[0];
      }

      // 3. fallback to last path segment
      const segments = urlObj.pathname.split('/').filter(Boolean);
      const last = segments[segments.length - 1] || '';
      return decodeURIComponent(last);
    };

    const convertLink = (raw) => {
      if (!raw) throw new Error('请先粘贴源链接');
      let urlObj;
      try {
        urlObj = new URL(raw.trim());
      } catch (err) {
        throw new Error('无法解析链接，请确认格式正确');
      }

      const base = normalizeBase(outputDomainEl.value || 'https://mori-pics.suimori.com');
      if (!base) throw new Error('请填写输出域名');

      const filename = pickFileName(urlObj);
      if (!filename) throw new Error('未能找到文件名，请检查链接');

      return `${base}/${filename}`;
    };

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      persistSettings();
      try {
        const result = convertLink(sourceEl.value);
        outputEl.textContent = result;
        outputEl.dataset.value = result;
      } catch (err) {
        outputEl.textContent = err.message;
        outputEl.dataset.value = '';
      }
    });

    copyBtn.addEventListener('click', async () => {
      const text = outputEl.dataset.value || outputEl.textContent;
      if (!text || text.startsWith('无法') || text.startsWith('未能') || text.startsWith('请')) return;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = '已复制!';
        setTimeout(() => copyBtn.textContent = '复制', 1400);
      } catch (err) {
        copyBtn.textContent = '复制失败';
        setTimeout(() => copyBtn.textContent = '复制', 1600);
      }
    });

    loadSettings();
  </script>
</body>
</html>
