<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#FAFAFA" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>YuzuSora · Cloud</title>
    <link
      rel="icon"
      href="https://mori-pics.suimori.com/KVNheFdLRdZAZBB5p6bckVesBZYIIePF.webp"
    />
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://chinese-fonts-cdn.deno.dev/packages/hcqyt/dist/ChillRoundFRegular/result.css"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["寒蝉全圆体", "system-ui", "sans-serif"],
              quicksand: ["Quicksand", "sans-serif"],
            },
            colors: {
              yuzu: {
                50: "#fffbeb",
                100: "#fef3c7",
                200: "#fde68a",
                400: "#fbbf24",
                500: "#f59e0b",
              },
            },
            boxShadow: {
              soft: "0 10px 40px -10px rgba(0,0,0,0.05)",
              card: "0 4px 6px -1px rgba(0,0,0,0.02)",
              glow: "0 0 15px rgba(251,191,36,0.3)",
            },
          },
        },
      };
    </script>
    <style>
      body {
        -webkit-tap-highlight-color: transparent;
        background-color: #fafafa;
        overscroll-behavior: none;
        font-weight: 400;
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }

      .glass-panel {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.8);
      }

      .toggle-checkbox:checked {
        right: 0;
        border-color: #fbbf24;
      }

      .toggle-checkbox:checked + .toggle-label {
        background-color: #fbbf24;
      }

      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #fbbf24;
        cursor: pointer;
        margin-top: -6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: #fde68a;
        border-radius: 2px;
      }

      @keyframes blob {
        0% {
          transform: translate(0px, 0px) scale(1);
        }

        33% {
          transform: translate(30px, -50px) scale(1.1);
        }

        66% {
          transform: translate(-20px, 20px) scale(0.9);
        }

        100% {
          transform: translate(0px, 0px) scale(1);
        }
      }

      .animate-blob {
        animation: blob 7s infinite;
      }

      .animation-delay-2000 {
        animation-delay: 2s;
      }

      .animation-delay-4000 {
        animation-delay: 4s;
      }

      @keyframes scale-in {
        from {
          transform: scale(0.95);
          opacity: 0;
        }

        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .animate-scale-in {
        animation: scale-in 0.2s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }

        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .animate-pop-in {
        animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      }
    </style>
  </head>

  <body class="antialiased text-slate-800">
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const API_BASE = "/api";

      const KAOMOJI = [
        "(｡•̀ᴗ-)✧",
        "(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄",
        "(๑•̀ㅂ•́)و✧",
        "(*^▽^*)",
        "( ◕ ᗜ ◕ )",
        "(✿◡‿◡)",
        "(ﾉ>ω<)ﾉ",
        "o(*￣▽￣*)o",
        "✨",
      ];
      const getRandomKaomoji = () =>
        KAOMOJI[Math.floor(Math.random() * KAOMOJI.length)];

      const api = {
        token: localStorage.getItem("mori_token"),
        setToken(t) {
          this.token = t;
          t
            ? localStorage.setItem("mori_token", t)
            : localStorage.removeItem("mori_token");
        },
        async request(path, opts = {}) {
          const headers = { ...opts.headers };
          if (this.token) headers["Authorization"] = `Bearer ${this.token}`;
          if (opts.body && !(opts.body instanceof FormData)) {
            headers["Content-Type"] = "application/json";
            opts.body = JSON.stringify(opts.body);
          }
          const res = await fetch(`${API_BASE}${path}`, { ...opts, headers });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "请求失败");
          return data;
        },
        checkSetup: () => api.request("/auth/setup"),
        setup: (u, p) =>
          api.request("/auth/setup", {
            method: "POST",
            body: { username: u, password: p },
          }),
        login: (u, p) =>
          api.request("/auth/login", {
            method: "POST",
            body: { username: u, password: p },
          }),
        getMe: () => api.request("/auth/me"),
        getImages: (params = {}) =>
          api.request(`/images?${new URLSearchParams(params)}`),
        uploadImage: (file, opts = {}) => {
          const fd = new FormData();
          fd.append("file", file);
          fd.append("originalName", file.name);
          if (opts.useOriginalFilename)
            fd.append("useOriginalFilename", "true");
          if (opts.isPublic !== undefined)
            fd.append("is_public", opts.isPublic ? "true" : "false");
          return api.request("/images", { method: "POST", body: fd });
        },
        deleteImage: (id, storage = true) =>
          api.request(`/images/${id}?storage=${storage}`, { method: "DELETE" }),
        updateImage: (id, data) =>
          api.request(`/images/${id}`, { method: "PATCH", body: data }),
        getPublicImages: (cursor = "", limit = 20) =>
          fetch(
            `${API_BASE}/images/public?cursor=${cursor}&limit=${limit}`
          ).then((r) => r.json()),
        getStatsOverview: () => api.request("/stats/overview"),
        getDailyStats: (days = 14) => api.request(`/stats/daily?days=${days}`),
      };

      const Icons = {
        Upload: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
            />
          </svg>
        ),
        Settings: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
            />
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
        ),
        Trash: () => (
          <svg
            className="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
            />
          </svg>
        ),
        Close: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        ),
        Link: () => (
          <svg
            className="w-3 h-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
            />
          </svg>
        ),
        Code: () => (
          <svg
            className="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"
            />
          </svg>
        ),
        Drag: () => (
          <svg
            className="w-8 h-8"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
            />
          </svg>
        ),
        Gallery: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
            />
          </svg>
        ),
        Chart: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            />
          </svg>
        ),
        Home: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
            />
          </svg>
        ),
        Logout: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
            />
          </svg>
        ),
        Search: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
        ),
        ChevronLeft: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M15 19l-7-7 7-7"
            />
          </svg>
        ),
        ChevronRight: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M9 5l7 7-7 7"
            />
          </svg>
        ),
        Alert: () => (
          <svg
            className="w-12 h-12 text-red-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            />
          </svg>
        ),
        History: () => (
          <svg
            className="w-12 h-12 text-blue-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
        ),
        Menu: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        ),
        Download: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
            />
          </svg>
        ),
        Login: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"
            />
          </svg>
        ),
        ZoomIn: () => (
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"
            />
          </svg>
        ),
        Check: () => (
          <svg
            className="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
        ),
        CheckAll: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
            />
          </svg>
        ),
        Eye: () => (
          <svg
            className="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
            />
          </svg>
        ),
        EyeOff: () => (
          <svg
            className="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
            />
          </svg>
        ),
        User: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
            />
          </svg>
        ),
        Shield: () => (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="1.5"
              d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
            />
          </svg>
        ),
      };

      // Background
      const Background = () => (
        <div className="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none bg-[#FAFAFA]">
          <div className="absolute top-[-10%] right-[-10%] w-[600px] h-[600px] bg-yellow-100/60 rounded-full mix-blend-multiply filter blur-[80px] opacity-70 animate-blob"></div>
          <div className="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-orange-100/60 rounded-full mix-blend-multiply filter blur-[80px] opacity-70 animate-blob animation-delay-2000"></div>
          <div className="absolute top-[30%] left-[30%] w-[400px] h-[400px] bg-pink-100/40 rounded-full mix-blend-multiply filter blur-[80px] opacity-70 animate-blob animation-delay-4000"></div>
        </div>
      );

      // Toast with bounce
      const Toast = ({ toast }) =>
        !toast ? null : (
          <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[200]">
            <div className="glass-panel px-6 py-3 rounded-full shadow-soft flex items-center gap-2 animate-bounce">
              <span
                className={
                  toast.type === "error" ? "text-red-500" : "text-yuzu-500"
                }
              >
                ●
              </span>
              <span className="text-sm font-medium text-slate-700 whitespace-nowrap">
                {toast.msg}
              </span>
            </div>
          </div>
        );

      // Copy Menu - Original style with Code icon
      const CopyMenu = ({ url, onCopy }) => {
        const [isOpen, setIsOpen] = useState(false);
        const menuRef = useRef(null);
        useEffect(() => {
          const handleClickOutside = (e) => {
            if (menuRef.current && !menuRef.current.contains(e.target))
              setIsOpen(false);
          };
          document.addEventListener("mousedown", handleClickOutside);
          return () =>
            document.removeEventListener("mousedown", handleClickOutside);
        }, []);
        const formats = [
          { label: "MD", text: `![img](${url})` },
          { label: "HTML", text: `<img src="${url}" />` },
          { label: "BB", text: `[img]${url}[/img]` },
        ];
        return (
          <div className="relative" ref={menuRef}>
            <button
              onClick={(e) => {
                e.stopPropagation();
                setIsOpen(!isOpen);
              }}
              className={`p-1.5 rounded-lg transition-colors ${
                isOpen
                  ? "bg-yuzu-50 text-yuzu-500"
                  : "text-slate-300 hover:text-yuzu-500 hover:bg-yuzu-50"
              }`}
              title="复制格式"
            >
              <Icons.Code />
            </button>
            {isOpen && (
              <div className="absolute bottom-full right-0 mb-2 bg-white rounded-xl shadow-xl border border-slate-100 p-1.5 flex gap-1 animate-pop-in z-20">
                {formats.map((fmt) => (
                  <button
                    key={fmt.label}
                    onClick={(e) => {
                      e.stopPropagation();
                      onCopy(fmt.text);
                      setIsOpen(false);
                    }}
                    className="px-2 py-1 text-[10px] font-bold text-slate-600 hover:bg-yuzu-50 hover:text-yuzu-600 rounded-lg transition-colors whitespace-nowrap"
                  >
                    {fmt.label}
                  </button>
                ))}
              </div>
            )}
          </div>
        );
      };

      // Delete Modal - Original style
      const DeleteModal = ({
        isOpen,
        onClose,
        onLocalDelete,
        onRemoteDelete,
        item,
      }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 animate-fade-in">
            <div
              className="absolute inset-0 bg-slate-900/30 backdrop-blur-sm"
              onClick={onClose}
            ></div>
            <div className="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative z-10 animate-pop-in">
              <div className="text-center mb-6">
                <h3 className="text-xl font-bold text-slate-800 mb-2">
                  删除图片？
                </h3>
                <p className="text-xs text-slate-500 font-mono px-4 truncate">
                  {item?.name || item?.filename}
                </p>
              </div>
              <div className="space-y-3">
                <button
                  onClick={onLocalDelete}
                  className="w-full p-4 rounded-2xl bg-blue-50 hover:bg-blue-100 transition-colors flex items-center gap-4 group text-left"
                >
                  <div className="p-2 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform">
                    <Icons.History />
                  </div>
                  <div>
                    <p className="font-bold text-blue-700 text-sm">
                      仅从列表移除
                    </p>
                    <p className="text-[10px] text-blue-400">
                      R2 中保留，链接仍有效
                    </p>
                  </div>
                </button>
                <button
                  onClick={onRemoteDelete}
                  className="w-full p-4 rounded-2xl bg-red-50 hover:bg-red-100 transition-colors flex items-center gap-4 group text-left border border-transparent hover:border-red-200"
                >
                  <div className="p-2 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform">
                    <Icons.Alert />
                  </div>
                  <div>
                    <p className="font-bold text-red-700 text-sm">彻底删除</p>
                    <p className="text-[10px] text-red-400">
                      从 R2 删除，链接立即失效
                    </p>
                  </div>
                </button>
              </div>
              <button
                onClick={onClose}
                className="w-full mt-6 py-3 text-slate-400 text-xs font-bold hover:text-slate-600 transition-colors"
              >
                取消
              </button>
            </div>
          </div>
        );
      };

      // Nav Bar - Clickable logo + hamburger menu
      const NavBar = ({
        currentPage,
        onPageChange,
        onLogout,
        onSettingsOpen,
        onGuestPreview,
        onS3SettingsOpen,
      }) => {
        const [menuOpen, setMenuOpen] = useState(false);
        const menuRef = useRef(null);
        useEffect(() => {
          const handleClickOutside = (e) => {
            if (menuRef.current && !menuRef.current.contains(e.target))
              setMenuOpen(false);
          };
          document.addEventListener("mousedown", handleClickOutside);
          return () =>
            document.removeEventListener("mousedown", handleClickOutside);
        }, []);
        const menuItems = [
          { id: "gallery", label: "图库", icon: <Icons.Gallery /> },
          { id: "stats", label: "统计", icon: <Icons.Chart /> },
        ];
        return (
          <nav className="w-full max-w-6xl px-6 py-6 flex justify-between items-center z-10">
            <div
              className="flex items-center gap-3 cursor-pointer group"
              onClick={() => onPageChange("upload")}
            >
              <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-lg border border-yuzu-100 relative overflow-hidden">
                <img
                  src="https://mori-pics.suimori.com/KVNheFdLRdZAZBB5p6bckVesBZYIIePF.webp"
                  className="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500"
                  alt="Logo"
                />
              </div>
              <div className="flex flex-col">
                <span className="font-bold text-2xl tracking-tight text-slate-900 leading-none font-quicksand group-hover:text-yuzu-600 transition-colors">
                  yuzusora
                </span>
                <span className="text-[10px] text-yuzu-500 font-bold tracking-widest mt-1">
                  IMAGE HOSTING
                </span>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={onGuestPreview}
                className="p-3 rounded-2xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:shadow-sm transition-all"
                title="访客模式"
              >
                <Icons.User />
              </button>
              <div className="relative" ref={menuRef}>
                <button
                  onClick={() => setMenuOpen(!menuOpen)}
                  className={`p-3 rounded-2xl transition-all ${
                    menuOpen
                      ? "bg-yuzu-100 text-yuzu-600 shadow-md"
                      : "bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:shadow-sm"
                  }`}
                >
                  {menuOpen ? <Icons.Close /> : <Icons.Menu />}
                </button>
                {menuOpen && (
                  <div className="absolute right-0 top-full mt-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-2 min-w-[160px] z-50 animate-pop-in">
                    {menuItems.map((item) => (
                      <button
                        key={item.id}
                        onClick={() => {
                          onPageChange(item.id);
                          setMenuOpen(false);
                        }}
                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors ${
                          currentPage === item.id
                            ? "bg-yuzu-50 text-yuzu-600"
                            : "text-slate-600 hover:bg-slate-50"
                        }`}
                      >
                        {item.icon} {item.label}
                      </button>
                    ))}
                    <div className="border-t border-slate-100 my-2"></div>
                    <button
                      onClick={() => {
                        onSettingsOpen();
                        setMenuOpen(false);
                      }}
                      className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-600 hover:bg-slate-50"
                    >
                      <Icons.Settings /> 设置
                    </button>
                    <button
                      onClick={() => {
                        onS3SettingsOpen();
                        setMenuOpen(false);
                      }}
                      className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-600 hover:bg-slate-50"
                    >
                      <svg
                        className="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth="1.5"
                          d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"
                        />
                      </svg>{" "}
                      存储
                    </button>
                    <div className="border-t border-slate-100 my-2"></div>
                    <button
                      onClick={() => {
                        onLogout();
                        setMenuOpen(false);
                      }}
                      className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-red-500 hover:bg-red-50"
                    >
                      <Icons.Logout /> 退出登录
                    </button>
                  </div>
                )}
              </div>
            </div>
          </nav>
        );
      };

      // Auth Page
      const AuthPage = ({ onAuth, needsSetup }) => {
        const [username, setUsername] = useState("");
        const [password, setPassword] = useState("");
        const [confirm, setConfirm] = useState("");
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (needsSetup && password !== confirm) {
            setError("密码不一致");
            return;
          }
          setLoading(true);
          try {
            const res = needsSetup
              ? await api.setup(username, password)
              : await api.login(username, password);
            api.setToken(res.data.token);
            onAuth(res.data.user);
          } catch (err) {
            setError(err.message);
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <Background />
            <div className="glass-panel rounded-[32px] p-8 w-full max-w-md animate-pop-in">
              <div className="text-center mb-8">
                <div className="w-20 h-20 mx-auto mb-4 rounded-2xl overflow-hidden shadow-lg">
                  <img
                    src="https://mori-pics.suimori.com/KVNheFdLRdZAZBB5p6bckVesBZYIIePF.webp"
                    className="w-full h-full object-cover"
                  />
                </div>
                <h1 className="text-2xl font-bold text-slate-800 font-quicksand">
                  yuzusora
                </h1>
                <p className="text-xs text-yuzu-500 font-bold tracking-widest mt-1">
                  {needsSetup ? "初始设置" : "IMAGE HOSTING"}
                </p>
              </div>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                    用户名
                  </label>
                  <input
                    type="text"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl px-4 py-3 outline-none transition-all placeholder:text-slate-300 focus:border-yuzu-400"
                    placeholder="admin"
                    required
                  />
                </div>
                <div>
                  <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                    密码
                  </label>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl px-4 py-3 outline-none transition-all placeholder:text-slate-300 focus:border-yuzu-400"
                    placeholder="••••••••"
                    required
                  />
                </div>
                {needsSetup && (
                  <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                      确认密码
                    </label>
                    <input
                      type="password"
                      value={confirm}
                      onChange={(e) => setConfirm(e.target.value)}
                      className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl px-4 py-3 outline-none transition-all placeholder:text-slate-300 focus:border-yuzu-400"
                      placeholder="••••••••"
                      required
                    />
                  </div>
                )}
                {error && (
                  <div className="p-3 bg-red-50 border border-red-100 rounded-xl text-red-600 text-sm">
                    {error}
                  </div>
                )}
                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg shadow-slate-200 active:scale-[0.98] transition-all hover:bg-slate-800 disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  {loading ? (
                    <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                  ) : needsSetup ? (
                    "创建管理员账号"
                  ) : (
                    "登录"
                  )}
                </button>
              </form>
              {needsSetup && (
                <p className="text-xs text-slate-400 text-center mt-4">
                  首次使用，请创建管理员账号
                </p>
              )}
            </div>
          </div>
        );
      };

      // Settings Modal
      const SettingsModal = ({ isOpen, onClose, config, setConfig }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div
              className="absolute inset-0 bg-slate-900/20 backdrop-blur-sm"
              onClick={onClose}
            ></div>
            <div className="bg-white w-full max-w-md rounded-[32px] p-8 shadow-2xl relative z-10 animate-scale-in max-h-[90vh] overflow-y-auto">
              <div className="flex justify-between items-center mb-8">
                <h2 className="text-xl font-bold text-slate-900">上传设置</h2>
                <button
                  onClick={onClose}
                  className="p-2 bg-slate-50 rounded-full hover:bg-slate-100 transition-colors text-slate-500"
                >
                  <Icons.Close />
                </button>
              </div>
              <div className="space-y-6">
                {/* WebP Compression */}
                <div className="p-4 bg-orange-50 rounded-2xl border border-orange-100">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-bold text-slate-700">
                        转换为 WebP
                      </p>
                      <p className="text-[10px] text-slate-400">
                        自动压缩，减小文件大小
                      </p>
                    </div>
                    <div className="relative inline-block w-10 align-middle select-none">
                      <input
                        type="checkbox"
                        id="webp"
                        className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all"
                        checked={config.compressWebp}
                        onChange={(e) =>
                          setConfig({
                            ...config,
                            compressWebp: e.target.checked,
                          })
                        }
                      />
                      <label
                        htmlFor="webp"
                        className={`toggle-label block h-5 rounded-full cursor-pointer transition-colors ${
                          config.compressWebp ? "bg-orange-400" : "bg-slate-300"
                        }`}
                      ></label>
                    </div>
                  </div>
                  {config.compressWebp && (
                    <div className="mt-4 animate-fade-in">
                      <div className="flex justify-between text-[10px] text-slate-500 font-bold mb-1">
                        <span>质量</span>
                        <span>{Math.round(config.compressQuality * 100)}%</span>
                      </div>
                      <input
                        type="range"
                        min="0.1"
                        max="1.0"
                        step="0.05"
                        value={config.compressQuality}
                        onChange={(e) =>
                          setConfig({
                            ...config,
                            compressQuality: parseFloat(e.target.value),
                          })
                        }
                      />
                    </div>
                  )}
                </div>
                {/* Use Original Filename */}
                <div className="flex items-center justify-between py-2">
                  <div>
                    <p className="text-sm font-bold text-slate-700">
                      保留原始文件名
                    </p>
                    <p className="text-[10px] text-slate-400">
                      关闭则自动重命名
                    </p>
                  </div>
                  <div className="relative inline-block w-10 align-middle select-none">
                    <input
                      type="checkbox"
                      id="filename"
                      className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all"
                      checked={config.useOriginalFilename}
                      onChange={(e) =>
                        setConfig({
                          ...config,
                          useOriginalFilename: e.target.checked,
                        })
                      }
                    />
                    <label
                      htmlFor="filename"
                      className={`toggle-label block h-5 rounded-full cursor-pointer transition-colors ${
                        config.useOriginalFilename
                          ? "bg-yuzu-400"
                          : "bg-slate-300"
                      }`}
                    ></label>
                  </div>
                </div>
                {/* Default Public */}
                <div className="flex items-center justify-between py-2">
                  <div>
                    <p className="text-sm font-bold text-slate-700">
                      默认公开图片
                    </p>
                    <p className="text-[10px] text-slate-400">
                      新上传图片默认可见性
                    </p>
                  </div>
                  <div className="relative inline-block w-10 align-middle select-none">
                    <input
                      type="checkbox"
                      id="defaultPublic"
                      className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all"
                      checked={config.defaultPublic}
                      onChange={(e) =>
                        setConfig({
                          ...config,
                          defaultPublic: e.target.checked,
                        })
                      }
                    />
                    <label
                      htmlFor="defaultPublic"
                      className={`toggle-label block h-5 rounded-full cursor-pointer transition-colors ${
                        config.defaultPublic ? "bg-green-400" : "bg-slate-300"
                      }`}
                    ></label>
                  </div>
                </div>
                {/* Gallery Click Behavior */}
                <div className="flex items-center justify-between py-2">
                  <div>
                    <p className="text-sm font-bold text-slate-700">
                      图库点击复制链接
                    </p>
                    <p className="text-[10px] text-slate-400">
                      关闭则点击进入预览
                    </p>
                  </div>
                  <div className="relative inline-block w-10 align-middle select-none">
                    <input
                      type="checkbox"
                      id="galleryClickCopy"
                      className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all"
                      checked={config.galleryClickCopy}
                      onChange={(e) =>
                        setConfig({
                          ...config,
                          galleryClickCopy: e.target.checked,
                        })
                      }
                    />
                    <label
                      htmlFor="galleryClickCopy"
                      className={`toggle-label block h-5 rounded-full cursor-pointer transition-colors ${
                        config.galleryClickCopy ? "bg-yuzu-400" : "bg-slate-300"
                      }`}
                    ></label>
                  </div>
                </div>
              </div>
              <button
                onClick={onClose}
                className="w-full mt-6 bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-[0.98] transition-all hover:bg-slate-800"
              >
                保存
              </button>
            </div>
          </div>
        );
      };

      // S3 Settings Modal
      const S3SettingsModal = ({ isOpen, onClose, showToast }) => {
        const [s3Config, setS3Config] = useState({
          endpoint: "",
          region: "",
          bucket: "",
          accessKeyId: "",
          secretAccessKey: "",
          publicDomain: "",
          urlStyle: "path", // 'path' or 'host'
          enabled: false,
        });
        const [loading, setLoading] = useState(false);
        const [showSecret, setShowSecret] = useState(false);

        useEffect(() => {
          if (isOpen) {
            setLoading(true);
            api
              .request("/settings/s3")
              .then((res) => {
                if (res.data) setS3Config({
                    ...res.data,
                    urlStyle: res.data.urlStyle || 'path'
                });
              })
              .catch(() => {})
              .finally(() => setLoading(false));
          }
        }, [isOpen]);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setLoading(true);
          // Trim inputs
          const cleanConfig = {
              ...s3Config,
              endpoint: s3Config.endpoint.trim(),
              region: s3Config.region.trim(),
              bucket: s3Config.bucket.trim(),
              accessKeyId: s3Config.accessKeyId.trim(),
              // Only trim secret if it's not the mask
              secretAccessKey: (s3Config.secretAccessKey && s3Config.secretAccessKey !== '******') ? s3Config.secretAccessKey.trim() : s3Config.secretAccessKey,
              publicDomain: s3Config.publicDomain.trim(),
          };

          try {
            await api.request("/settings/s3", { method: "PUT", body: cleanConfig });
            showToast("S3 配置已保存 ✨");
            onClose();
          } catch (err) {
            showToast(`保存失败: ${err.message}`, "error");
          } finally {
            setLoading(false);
          }
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div
              className="absolute inset-0 bg-slate-900/20 backdrop-blur-sm"
              onClick={onClose}
            ></div>
            <div className="bg-white w-full max-w-md rounded-[32px] p-8 shadow-2xl relative z-10 animate-scale-in max-h-[90vh] overflow-y-auto">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-slate-900">S3 存储设置</h2>
                <button
                  onClick={onClose}
                  className="p-2 bg-slate-50 rounded-full hover:bg-slate-100 transition-colors text-slate-500"
                >
                  <Icons.Close />
                </button>
              </div>

              <form onSubmit={handleSubmit} className="space-y-4">
                <div className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 mb-4">
                  <div>
                    <p className="text-sm font-bold text-slate-700">启用 Custom S3</p>
                    <p className="text-[10px] text-slate-400">使用自定义 S3 存储服务</p>
                  </div>
                  <div className="relative inline-block w-10 align-middle select-none">
                    <input
                      type="checkbox"
                      id="s3Enabled"
                      className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all"
                      checked={s3Config.enabled}
                      onChange={(e) =>
                        setS3Config({ ...s3Config, enabled: e.target.checked })
                      }
                    />
                    <label
                      htmlFor="s3Enabled"
                      className={`toggle-label block h-5 rounded-full cursor-pointer transition-colors ${
                        s3Config.enabled ? "bg-yuzu-400" : "bg-slate-300"
                      }`}
                    ></label>
                  </div>
                </div>

                <div className="space-y-3">
                  <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                      Endpoint (API 地址)
                    </label>
                    <input
                      type="text"
                      value={s3Config.endpoint}
                      onChange={(e) =>
                        setS3Config({ ...s3Config, endpoint: e.target.value })
                      }
                      className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl px-4 py-2.5 outline-none focus:border-yuzu-400"
                      placeholder="https://s3.example.com"
                      required={s3Config.enabled}
                    />
                  </div>
                  
                  {/* URL Style Toggle - Mobile Friendly */}
                   <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-3">URL Style</span>
                        <div className="flex flex-col sm:flex-row gap-3">
                             <label className={`flex-1 flex items-center p-3 rounded-xl border cursor-pointer transition-all ${s3Config.urlStyle === 'path' ? 'bg-white border-yuzu-400 ring-2 ring-yuzu-100 shadow-sm' : 'border-transparent hover:bg-white hover:border-slate-200'}`}>
                                  <input type="radio" name="urlStyle" value="path" checked={s3Config.urlStyle === 'path'} onChange={(e) => setS3Config({...s3Config, urlStyle: 'path'})} className="accent-yuzu-400 w-4 h-4 mr-3" />
                                  <div>
                                     <span className="block text-sm font-bold text-slate-700">Path Style</span>
                                     <span className="block text-[10px] text-slate-400 break-all">/bucket/key</span>
                                  </div>
                             </label>
                             <label className={`flex-1 flex items-center p-3 rounded-xl border cursor-pointer transition-all ${s3Config.urlStyle === 'host' ? 'bg-white border-yuzu-400 ring-2 ring-yuzu-100 shadow-sm' : 'border-transparent hover:bg-white hover:border-slate-200'}`}>
                                  <input type="radio" name="urlStyle" value="host" checked={s3Config.urlStyle === 'host'} onChange={(e) => setS3Config({...s3Config, urlStyle: 'host'})} className="accent-yuzu-400 w-4 h-4 mr-3" />
                                  <div>
                                     <span className="block text-sm font-bold text-slate-700">Virtual Host</span>
                                     <span className="block text-[10px] text-slate-400 break-all">bucket.endpoint/key</span>
                                  </div>
                             </label>
                        </div>
                   </div>

                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                        Region (区域)
                      </label>
                      <input
                        type="text"
                        value={s3Config.region}
                        onChange={(e) =>
                          setS3Config({ ...s3Config, region: e.target.value })
                        }
                        className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl px-4 py-2.5 outline-none focus:border-yuzu-400"
                        placeholder="auto"
                      />
                    </div>
                    <div>
                      <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                        Bucket (存储桶)
                      </label>
                      <input
                        type="text"
                        value={s3Config.bucket}
                        onChange={(e) =>
                          setS3Config({ ...s3Config, bucket: e.target.value })
                        }
                        className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl px-4 py-2.5 outline-none focus:border-yuzu-400"
                        placeholder="my-bucket"
                        required={s3Config.enabled}
                      />
                    </div>
                  </div>
                  <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                      Access Key ID
                    </label>
                    <input
                      type="text"
                      value={s3Config.accessKeyId}
                      onChange={(e) =>
                        setS3Config({ ...s3Config, accessKeyId: e.target.value })
                      }
                      className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl px-4 py-2.5 outline-none focus:border-yuzu-400"
                      placeholder="Access Key"
                      required={s3Config.enabled}
                    />
                  </div>
                  <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                      Secret Access Key
                    </label>
                    <div className="relative">
                        <input
                          type={showSecret ? "text" : "password"}
                          value={s3Config.secretAccessKey}
                          onChange={(e) =>
                            setS3Config({
                              ...s3Config,
                              secretAccessKey: e.target.value,
                            })
                          }
                          className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl px-4 py-2.5 outline-none focus:border-yuzu-400 pr-10"
                          placeholder={s3Config.secretAccessKey ? "已设置 (如需修改请直接输入)" : "Secret Key"}
                        />
                        <button type="button" onClick={() => setShowSecret(!showSecret)} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                             {showSecret ? (
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                             ) : (
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                             )}
                        </button>
                    </div>
                  </div>
                  <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">
                      Public Domain (自定义域名, 可选)
                    </label>
                    <input
                      type="text"
                      value={s3Config.publicDomain}
                      onChange={(e) =>
                        setS3Config({ ...s3Config, publicDomain: e.target.value })
                      }
                      className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl px-4 py-2.5 outline-none focus:border-yuzu-400"
                      placeholder="https://cdn.example.com"
                    />
                    <p className="text-[10px] text-slate-400 mt-1 ml-1 px-1">如果不填写，将使用当前的 Worker 作为代理访问图片。</p>
                  </div>
                </div>

                <button
                  type="submit"
                  disabled={loading}
                  className="w-full mt-6 bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-[0.98] transition-all hover:bg-slate-800 disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  {loading ? (
                    <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                  ) : (
                    "保存配置"
                  )}
                </button>
              </form>
            </div>
          </div>
        );
      };

      // Upload Page
      const UploadPage = ({ showToast, config }) => {
        const [uploading, setUploading] = useState(false);
        const [dragging, setDragging] = useState(false);
        const [uploads, setUploads] = useState(() => {
          const saved = localStorage.getItem("mori_recent_uploads");
          return saved ? JSON.parse(saved) : [];
        });
        const [deleteTarget, setDeleteTarget] = useState(null);
        const fileRef = useRef();

        // Persist uploads to localStorage
        useEffect(() => {
          localStorage.setItem("mori_recent_uploads", JSON.stringify(uploads));
        }, [uploads]);

        const copyToClipboard = (text) => {
          navigator.clipboard
            .writeText(text)
            .then(() => showToast(`已复制 ${getRandomKaomoji()}`))
            .catch(() => showToast("复制失败", "error"));
        };

        const compress = (file, q) =>
          new Promise((resolve) => {
            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => {
              const c = document.createElement("canvas");
              c.width = img.width;
              c.height = img.height;
              c.getContext("2d").drawImage(img, 0, 0);
              c.toBlob(
                (b) =>
                  resolve(
                    b
                      ? new File([b], file.name.replace(/\.[^.]+$/, ".webp"), {
                          type: "image/webp",
                        })
                      : file
                  ),
                "image/webp",
                q
              );
            };
            img.onerror = () => resolve(file);
          });

        const upload = async (file) => {
          setUploading(true);
          try {
            let f = file,
              oldSize = file.size,
              compressed = false;
            if (
              config.compressWebp &&
              file.type !== "image/gif" &&
              file.type.startsWith("image/")
            ) {
              f = await compress(file, config.compressQuality);
              compressed = true;
            }
            const res = await api.uploadImage(f, {
              useOriginalFilename: config.useOriginalFilename,
              isPublic: config.defaultPublic,
            });
            setUploads((prev) =>
              [
                {
                  id: res.data.id,
                  url: res.data.url,
                  name: res.data.filename,
                  date: new Date().toLocaleDateString(),
                },
                ...prev,
              ].slice(0, 20)
            );
            copyToClipboard(res.data.url);
            showToast(
              compressed
                ? `已上传，节省 ${((oldSize - f.size) / 1024).toFixed(1)}KB ✨`
                : `上传成功 ${getRandomKaomoji()}`
            );
          } catch (err) {
            showToast(`上传失败: ${err.message}`, "error");
          } finally {
            setUploading(false);
            setDragging(false);
          }
        };

        useEffect(() => {
          const paste = (e) => {
            const items = e.clipboardData?.items;
            if (items)
              for (let i of items)
                if (i.type.startsWith("image/")) {
                  upload(i.getAsFile());
                  break;
                }
          };
          window.addEventListener("paste", paste);
          return () => window.removeEventListener("paste", paste);
        }, [config]);

        const handleLocalDelete = () => {
          setUploads((prev) => prev.filter((i) => i.id !== deleteTarget.id));
          setDeleteTarget(null);
          showToast(`已从列表移除 ${getRandomKaomoji()}`);
        };
        const handleRemoteDelete = async () => {
          try {
            await api.deleteImage(deleteTarget.id, true);
            setUploads((prev) => prev.filter((i) => i.id !== deleteTarget.id));
            showToast(`已从 R2 删除 ${getRandomKaomoji()}`);
          } catch (err) {
            showToast(`删除失败: ${err.message}`, "error");
          } finally {
            setDeleteTarget(null);
          }
        };

        return (
          <main
            className="w-full max-w-6xl px-6 grid grid-cols-1 lg:grid-cols-12 gap-8 items-start"
            onDragOver={(e) => {
              e.preventDefault();
              setDragging(true);
            }}
            onDragLeave={(e) => {
              e.preventDefault();
              setDragging(false);
            }}
            onDrop={(e) => {
              e.preventDefault();
              setDragging(false);
              e.dataTransfer.files[0] && upload(e.dataTransfer.files[0]);
            }}
          >
            {dragging && (
              <div className="fixed inset-0 z-[100] bg-yuzu-500/20 backdrop-blur-sm border-8 border-dashed border-yuzu-400 flex items-center justify-center pointer-events-none animate-pulse">
                <div className="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center">
                  <div className="text-yuzu-500 mb-4 animate-bounce">
                    <Icons.Drag />
                  </div>
                  <h2 className="text-2xl font-bold text-slate-800">
                    放开上传！
                  </h2>
                </div>
              </div>
            )}

            <DeleteModal
              isOpen={!!deleteTarget}
              onClose={() => setDeleteTarget(null)}
              onLocalDelete={handleLocalDelete}
              onRemoteDelete={handleRemoteDelete}
              item={deleteTarget}
            />

            <div className="lg:col-span-5 lg:sticky lg:top-24 space-y-6">
              <div
                className={`glass-panel rounded-[32px] p-2 relative overflow-hidden group cursor-pointer transition-all duration-500 hover:shadow-lg hover:-translate-y-1 active:scale-[0.99] active:translate-y-0 ${
                  dragging ? "ring-4 ring-yuzu-400" : ""
                }`}
                onClick={() => fileRef.current.click()}
              >
                <div className="bg-white/60 rounded-[24px] aspect-[4/3] lg:aspect-square border-2 border-dashed border-slate-200 group-hover:border-yuzu-400 transition-colors flex flex-col items-center justify-center gap-5 relative overflow-hidden">
                  <input
                    ref={fileRef}
                    type="file"
                    className="hidden"
                    accept="image/*"
                    onChange={(e) =>
                      e.target.files[0] && upload(e.target.files[0])
                    }
                  />
                  {uploading ? (
                    <div className="flex flex-col items-center gap-4 animate-pulse">
                      <div className="w-16 h-16 border-4 border-yuzu-100 border-t-yuzu-400 rounded-full animate-spin"></div>
                      <span className="text-sm font-medium text-slate-500 tracking-wide">
                        上传中...
                      </span>
                    </div>
                  ) : (
                    <>
                      <div className="w-20 h-20 bg-white rounded-3xl shadow-card flex items-center justify-center text-slate-300 group-hover:scale-110 transition-transform duration-500 group-hover:text-yuzu-500 group-hover:rotate-3 group-hover:shadow-glow">
                        <Icons.Upload />
                      </div>
                      <div className="text-center z-10">
                        <p className="text-lg font-bold text-slate-700 mb-1 group-hover:text-yuzu-600 transition-colors">
                          点击、粘贴或拖放
                        </p>
                        <p className="text-xs text-slate-400 font-medium">
                          JPG, PNG, GIF, WEBP
                        </p>
                      </div>
                      <div className="absolute inset-x-0 bottom-0 h-1 bg-yuzu-400 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-500"></div>
                    </>
                  )}
                </div>
              </div>
            </div>

            <div className="lg:col-span-7 pb-20">
              <div className="flex items-center justify-between mb-6 px-1">
                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest">
                  最近上传
                </h3>
                <span className="text-[10px] font-bold text-yuzu-500 bg-yuzu-50 border border-yuzu-100 px-2 py-1 rounded-full">
                  {uploads.length} 项
                </span>
              </div>
              {uploads.length === 0 ? (
                <div className="flex flex-col items-center justify-center py-20 text-slate-300 border-2 border-dashed border-slate-100 rounded-3xl bg-white/30">
                  <div className="mb-3 opacity-50">
                    <Icons.Upload />
                  </div>
                  <p className="text-sm font-medium">上传图片开始使用</p>
                  <p className="text-xs opacity-50 mt-1">或 Ctrl + V 粘贴</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {uploads.map((item) => (
                    <div
                      key={item.id}
                      onClick={() => copyToClipboard(item.url)}
                      className="group relative bg-white rounded-2xl p-2.5 shadow-sm border border-slate-100 hover:shadow-md transition-all active:scale-[0.98] cursor-pointer"
                    >
                      <div className="aspect-video w-full rounded-xl bg-slate-50 overflow-hidden relative mb-3">
                        <img
                          src={item.url}
                          className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                          loading="lazy"
                        />
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors"></div>
                        <div className="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">
                          <div className="bg-white/90 backdrop-blur text-xs px-2 py-1 rounded-lg shadow-sm font-medium flex items-center gap-1">
                            <Icons.Link /> 复制
                          </div>
                        </div>
                      </div>
                      <div className="flex justify-between items-start px-1 relative">
                        <div className="min-w-0 pr-16">
                          <p className="text-sm font-bold text-slate-700 truncate">
                            {item.name}
                          </p>
                          <p className="text-[10px] text-slate-400 font-medium mt-0.5">
                            {item.date}
                          </p>
                        </div>
                        <div className="absolute right-0 top-0 flex gap-1">
                          <CopyMenu url={item.url} onCopy={copyToClipboard} />
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setDeleteTarget(item);
                            }}
                            className="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                            title="删除"
                          >
                            <Icons.Trash />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </main>
        );
      };

      // Batch Delete Modal
      const BatchDeleteModal = ({
        isOpen,
        onClose,
        count,
        onLocalDelete,
        onRemoteDelete,
      }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 animate-fade-in">
            <div
              className="absolute inset-0 bg-slate-900/30 backdrop-blur-sm"
              onClick={onClose}
            ></div>
            <div className="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative z-10 animate-pop-in">
              <div className="text-center mb-6">
                <h3 className="text-xl font-bold text-slate-800 mb-2">
                  批量删除 {count} 张图片？
                </h3>
                <p className="text-xs text-slate-500">此操作无法撤销</p>
              </div>
              <div className="space-y-3">
                <button
                  onClick={onLocalDelete}
                  className="w-full p-4 rounded-2xl bg-blue-50 hover:bg-blue-100 transition-colors flex items-center gap-4 group text-left"
                >
                  <div className="p-2 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform">
                    <Icons.History />
                  </div>
                  <div>
                    <p className="font-bold text-blue-700 text-sm">
                      仅从列表移除
                    </p>
                    <p className="text-[10px] text-blue-400">
                      R2 中保留，链接仍有效
                    </p>
                  </div>
                </button>
                <button
                  onClick={onRemoteDelete}
                  className="w-full p-4 rounded-2xl bg-red-50 hover:bg-red-100 transition-colors flex items-center gap-4 group text-left border border-transparent hover:border-red-200"
                >
                  <div className="p-2 bg-white rounded-full shadow-sm group-hover:scale-110 transition-transform">
                    <Icons.Alert />
                  </div>
                  <div>
                    <p className="font-bold text-red-700 text-sm">彻底删除</p>
                    <p className="text-[10px] text-red-400">
                      从 R2 删除，链接立即失效
                    </p>
                  </div>
                </button>
              </div>
              <button
                onClick={onClose}
                className="w-full mt-6 py-3 text-slate-400 text-xs font-bold hover:text-slate-600 transition-colors"
              >
                取消
              </button>
            </div>
          </div>
        );
      };

      // Gallery Page
      const GalleryPage = ({ showToast, config }) => {
        const [images, setImages] = useState([]);
        const [loading, setLoading] = useState(true);
        const [page, setPage] = useState(1);
        const [totalPages, setTotalPages] = useState(1);
        const [search, setSearch] = useState("");
        const [deleteTarget, setDeleteTarget] = useState(null);
        // Batch operations state
        const [selectMode, setSelectMode] = useState(false);
        const [selected, setSelected] = useState(new Set());
        const [batchDeleteOpen, setBatchDeleteOpen] = useState(false);
        // Preview state
        const [previewImage, setPreviewImage] = useState(null);
        const [lightboxImage, setLightboxImage] = useState(null);

        const copyToClipboard = (text) =>
          navigator.clipboard
            .writeText(text)
            .then(() => showToast(`已复制 ${getRandomKaomoji()}`));

        const fetchImages = async (p = 1, s = "") => {
          setLoading(true);
          try {
            const res = await api.getImages({
              page: p,
              pageSize: 20,
              search: s,
            });
            setImages(res.data.items);
            setTotalPages(res.data.totalPages);
            setPage(res.data.page);
          } catch (err) {
            showToast(`加载失败: ${err.message}`, "error");
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => {
          fetchImages();
        }, []);

        // Clear selection when exiting select mode
        useEffect(() => {
          if (!selectMode) setSelected(new Set());
        }, [selectMode]);

        // Single delete handlers
        const handleLocalDelete = () => {
          setImages((prev) => prev.filter((i) => i.id !== deleteTarget.id));
          setDeleteTarget(null);
          showToast(`已从列表移除 ${getRandomKaomoji()}`);
        };
        const handleRemoteDelete = async () => {
          try {
            await api.deleteImage(deleteTarget.id, true);
            setImages((prev) => prev.filter((i) => i.id !== deleteTarget.id));
            showToast(`已从 R2 删除 ${getRandomKaomoji()}`);
          } catch (err) {
            showToast(`删除失败: ${err.message}`, "error");
          } finally {
            setDeleteTarget(null);
          }
        };

        // Batch operations
        const toggleSelect = (id) => {
          setSelected((prev) => {
            const next = new Set(prev);
            next.has(id) ? next.delete(id) : next.add(id);
            return next;
          });
        };

        const selectAll = () => setSelected(new Set(images.map((i) => i.id)));
        const deselectAll = () => setSelected(new Set());

        const handleBatchLocalDelete = async () => {
          const ids = Array.from(selected);
          setImages((prev) => prev.filter((i) => !selected.has(i.id)));
          setSelected(new Set());
          setBatchDeleteOpen(false);
          setSelectMode(false);
          showToast(`已从列表移除 ${ids.length} 张图片 ${getRandomKaomoji()}`);
        };

        const handleBatchRemoteDelete = async () => {
          const ids = Array.from(selected);
          let successCount = 0;
          for (const id of ids) {
            try {
              await api.deleteImage(id, true);
              successCount++;
            } catch {}
          }
          setImages((prev) => prev.filter((i) => !selected.has(i.id)));
          setSelected(new Set());
          setBatchDeleteOpen(false);
          setSelectMode(false);
          showToast(
            `已删除 ${successCount}/${ids.length} 张图片 ${getRandomKaomoji()}`
          );
        };

        const handleExport = () => {
          const toExport = images.filter((i) => selected.has(i.id));
          if (toExport.length === 0) return;
          toExport.forEach((img) => window.open(img.url, "_blank"));
          showToast(
            `已在新标签页打开 ${
              toExport.length
            } 张图片，请右键保存 ${getRandomKaomoji()}`
          );
        };

        // Toggle visibility
        const toggleVisibility = async (item, e) => {
          e.stopPropagation();
          try {
            const newPublic = item.is_public ? 0 : 1;
            await api.updateImage(item.id, { is_public: newPublic });
            setImages((prev) =>
              prev.map((i) =>
                i.id === item.id ? { ...i, is_public: newPublic } : i
              )
            );
            showToast(
              newPublic
                ? `已设为公开 ${getRandomKaomoji()}`
                : `已设为私有 ${getRandomKaomoji()}`
            );
          } catch (err) {
            showToast(`修改失败: ${err.message}`, "error");
          }
        };

        const handleCardClick = (item) => {
          if (selectMode) {
            toggleSelect(item.id);
          } else if (config.galleryClickCopy) {
            copyToClipboard(item.url);
          } else {
            setPreviewImage(item);
          }
        };

        return (
          <div className="w-full max-w-6xl px-6 pb-20">
            <DeleteModal
              isOpen={!!deleteTarget}
              onClose={() => setDeleteTarget(null)}
              onLocalDelete={handleLocalDelete}
              onRemoteDelete={handleRemoteDelete}
              item={deleteTarget}
            />
            <BatchDeleteModal
              isOpen={batchDeleteOpen}
              onClose={() => setBatchDeleteOpen(false)}
              count={selected.size}
              onLocalDelete={handleBatchLocalDelete}
              onRemoteDelete={handleBatchRemoteDelete}
            />
            <ImageDetail
              image={previewImage}
              onClose={() => setPreviewImage(null)}
              onZoom={setLightboxImage}
              showToast={showToast}
            />
            <Lightbox
              image={lightboxImage}
              onClose={() => setLightboxImage(null)}
            />

            {/* Toolbar */}
            <div className="flex flex-wrap gap-3 mb-6">
              {/* Search */}
              <form
                onSubmit={(e) => {
                  e.preventDefault();
                  fetchImages(1, search);
                }}
                className="flex-1 min-w-[200px]"
              >
                <div className="relative">
                  <input
                    type="text"
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    placeholder="搜索图片..."
                    className="w-full bg-white border border-slate-200 rounded-xl px-4 py-2.5 pl-10 outline-none focus:border-yuzu-400 transition-colors text-sm"
                  />
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                    <Icons.Search />
                  </div>
                </div>
              </form>

              {/* Action buttons */}
              <div className="flex gap-2">
                <button
                  onClick={() => setSelectMode(!selectMode)}
                  className={`px-4 py-2.5 rounded-xl text-sm font-medium flex items-center gap-2 transition-colors ${
                    selectMode
                      ? "bg-yuzu-400 text-white"
                      : "bg-white border border-slate-200 text-slate-600 hover:bg-slate-50"
                  }`}
                >
                  <Icons.CheckAll /> {selectMode ? "取消" : "选择"}
                </button>
                {selectMode && (
                  <>
                    <button
                      onClick={
                        selected.size === images.length
                          ? deselectAll
                          : selectAll
                      }
                      className="px-4 py-2.5 rounded-xl text-sm font-medium bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors"
                    >
                      {selected.size === images.length ? "取消全选" : "全选"}
                    </button>
                    <button
                      onClick={() => setBatchDeleteOpen(true)}
                      disabled={selected.size === 0}
                      className="px-4 py-2.5 rounded-xl text-sm font-medium bg-red-50 border border-red-200 text-red-600 hover:bg-red-100 disabled:opacity-50 transition-colors flex items-center gap-2"
                    >
                      <Icons.Trash /> 删除 ({selected.size})
                    </button>
                    <button
                      onClick={handleExport}
                      disabled={selected.size === 0}
                      className="px-4 py-2.5 rounded-xl text-sm font-medium bg-blue-50 border border-blue-200 text-blue-600 hover:bg-blue-100 disabled:opacity-50 transition-colors flex items-center gap-2"
                    >
                      <Icons.Download /> 导出 ({selected.size})
                    </button>
                  </>
                )}
              </div>
            </div>

            {loading ? (
              <div className="flex justify-center py-20">
                <div className="w-16 h-16 border-4 border-yuzu-100 border-t-yuzu-400 rounded-full animate-spin"></div>
              </div>
            ) : images.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-20 text-slate-300 border-2 border-dashed border-slate-100 rounded-3xl bg-white/30">
                <Icons.Gallery />
                <p className="text-sm font-medium">没有找到图片</p>
              </div>
            ) : (
              <>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  {images.map((item) => (
                    <div
                      key={item.id}
                      onClick={() => handleCardClick(item)}
                      className={`group relative bg-white rounded-2xl p-2.5 shadow-sm border transition-all active:scale-[0.98] cursor-pointer ${
                        selectMode && selected.has(item.id)
                          ? "border-yuzu-400 ring-2 ring-yuzu-200"
                          : "border-slate-100 hover:shadow-md"
                      }`}
                    >
                      <div className="aspect-video w-full rounded-xl bg-slate-50 overflow-hidden relative mb-3">
                        <img
                          src={item.url}
                          className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                          loading="lazy"
                        />
                        {/* Selection checkbox overlay */}
                        {selectMode && (
                          <div
                            className={`absolute top-2 left-2 w-6 h-6 rounded-lg flex items-center justify-center transition-colors ${
                              selected.has(item.id)
                                ? "bg-yuzu-400 text-white"
                                : "bg-white/80 border border-slate-300"
                            }`}
                          >
                            {selected.has(item.id) && <Icons.Check />}
                          </div>
                        )}
                        {/* Visibility indicator */}
                        <div
                          className={`absolute top-2 right-2 px-2 py-1 rounded-lg text-[10px] font-bold flex items-center gap-1 ${
                            item.is_public
                              ? "bg-green-100 text-green-600"
                              : "bg-slate-100 text-slate-500"
                          }`}
                        >
                          {item.is_public ? (
                            <>
                              <Icons.Eye /> 公开
                            </>
                          ) : (
                            <>
                              <Icons.EyeOff /> 私有
                            </>
                          )}
                        </div>
                        {/* Copy hint */}
                        {!selectMode && config.galleryClickCopy && (
                          <div className="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <div className="bg-white/90 backdrop-blur text-xs px-2 py-1 rounded-lg shadow-sm font-medium flex items-center gap-1">
                              <Icons.Link /> 复制
                            </div>
                          </div>
                        )}
                        {!selectMode && !config.galleryClickCopy && (
                          <div className="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <div className="bg-white/90 backdrop-blur text-xs px-2 py-1 rounded-lg shadow-sm font-medium flex items-center gap-1">
                              <Icons.ZoomIn /> 预览
                            </div>
                          </div>
                        )}
                      </div>
                      <div className="flex justify-between items-start px-1">
                        <div className="min-w-0 pr-20">
                          <p className="text-sm font-bold text-slate-700 truncate">
                            {item.filename}
                          </p>
                          <p className="text-[10px] text-slate-400 font-medium mt-0.5">
                            {new Date(item.created_at).toLocaleDateString()}
                          </p>
                        </div>
                        <div className="absolute right-3 bottom-3 flex gap-1">
                          {/* Visibility toggle */}
                          <button
                            onClick={(e) => toggleVisibility(item, e)}
                            className={`p-1.5 rounded-lg transition-colors ${
                              item.is_public
                                ? "text-green-500 hover:bg-green-50"
                                : "text-slate-300 hover:text-slate-500 hover:bg-slate-50"
                            }`}
                            title={item.is_public ? "设为私有" : "设为公开"}
                          >
                            {item.is_public ? <Icons.Eye /> : <Icons.EyeOff />}
                          </button>
                          <CopyMenu url={item.url} onCopy={copyToClipboard} />
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setDeleteTarget(item);
                            }}
                            className="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                          >
                            <Icons.Trash />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="flex justify-center items-center gap-4 mt-8">
                  <button
                    onClick={() => fetchImages(page - 1, search)}
                    disabled={page <= 1}
                    className="p-2 rounded-xl bg-white border border-slate-200 disabled:opacity-50 hover:bg-slate-50 transition-colors"
                  >
                    <Icons.ChevronLeft />
                  </button>
                  <span className="text-sm font-medium text-slate-600">
                    {page} / {totalPages}
                  </span>
                  <button
                    onClick={() => fetchImages(page + 1, search)}
                    disabled={page >= totalPages}
                    className="p-2 rounded-xl bg-white border border-slate-200 disabled:opacity-50 hover:bg-slate-50 transition-colors"
                  >
                    <Icons.ChevronRight />
                  </button>
                </div>
              </>
            )}
          </div>
        );
      };

      // Stats Page
      const StatsPage = ({ showToast }) => {
        const [overview, setOverview] = useState(null);
        const [daily, setDaily] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          Promise.all([api.getStatsOverview(), api.getDailyStats(14)])
            .then(([o, d]) => {
              setOverview(o.data);
              setDaily(d.data);
            })
            .catch((e) => showToast(`加载失败: ${e.message}`, "error"))
            .finally(() => setLoading(false));
        }, []);

        const formatBytes = (b) => {
          if (!b) return "0 B";
          const k = 1024,
            s = ["B", "KB", "MB", "GB"],
            i = Math.floor(Math.log(b) / Math.log(k));
          return (b / Math.pow(k, i)).toFixed(1) + " " + s[i];
        };

        if (loading)
          return (
            <div className="flex justify-center py-20">
              <div className="w-16 h-16 border-4 border-yuzu-100 border-t-yuzu-400 rounded-full animate-spin"></div>
            </div>
          );

        const maxUploads = Math.max(...daily.map((s) => s.upload_count), 1);
        return (
          <div className="w-full max-w-6xl px-6 pb-20">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
              <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">
                  总图片
                </p>
                <p className="text-3xl font-bold text-slate-800">
                  {overview?.totalImages || 0}
                </p>
              </div>
              <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">
                  总大小
                </p>
                <p className="text-3xl font-bold text-slate-800">
                  {formatBytes(overview?.totalSize)}
                </p>
              </div>
              <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">
                  总浏览
                </p>
                <p className="text-3xl font-bold text-slate-800">
                  {overview?.totalViews || 0}
                </p>
              </div>
              <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">
                  今日上传
                </p>
                <p className="text-3xl font-bold text-yuzu-500">
                  {overview?.todayUploads || 0}
                </p>
              </div>
            </div>
            <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
              <h3 className="text-sm font-bold text-slate-700 mb-4">
                最近 14 天
              </h3>
              <div className="flex items-end gap-1 h-32">
                {daily.map((stat) => (
                  <div
                    key={stat.date}
                    className="flex-1 flex flex-col items-center gap-1"
                  >
                    <div
                      className="w-full bg-yuzu-400 rounded-t transition-all hover:bg-yuzu-500"
                      style={{
                        height: `${(stat.upload_count / maxUploads) * 100}%`,
                        minHeight: stat.upload_count > 0 ? "8px" : "2px",
                      }}
                      title={`${stat.date}: ${stat.upload_count} 次上传`}
                    ></div>
                    <span className="text-[8px] text-slate-400">
                      {stat.date.slice(5)}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      };

      // Lightbox - Full screen image preview
      const Lightbox = ({ image, onClose }) => {
        if (!image) return null;
        return (
          <div
            className="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center animate-fade-in"
            onClick={onClose}
          >
            <button
              onClick={onClose}
              className="absolute top-4 right-4 p-3 text-white/70 hover:text-white"
            >
              <Icons.Close />
            </button>
            <img
              src={image.url}
              className="max-w-full max-h-full object-contain"
              onClick={(e) => e.stopPropagation()}
            />
          </div>
        );
      };

      // Image Detail Modal - Copy/Download
      const ImageDetail = ({ image, onClose, onZoom, showToast }) => {
        if (!image) return null;
        const copy = (text) =>
          navigator.clipboard
            .writeText(text)
            .then(() => showToast(`已复制 ${getRandomKaomoji()}`));
        const download = () => {
          const a = document.createElement("a");
          a.href = `/api/images/${image.id}/download`;
          a.download = image.original_name || image.filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          showToast(`开始下载 ${getRandomKaomoji()}`);
        };
        return (
          <div
            className="fixed inset-0 z-[90] flex items-center justify-center p-4 animate-fade-in"
            onClick={onClose}
          >
            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div
              className="relative z-10 bg-white rounded-3xl overflow-hidden max-w-2xl w-full shadow-2xl animate-pop-in"
              onClick={(e) => e.stopPropagation()}
            >
              <div
                className="relative cursor-zoom-in"
                onClick={() => onZoom(image)}
              >
                <img
                  src={image.url}
                  className="w-full max-h-[60vh] object-contain bg-slate-100"
                />
                <div className="absolute bottom-3 right-3 bg-black/50 text-white px-3 py-1.5 rounded-full text-xs flex items-center gap-1">
                  <Icons.ZoomIn /> 点击放大
                </div>
              </div>
              <div className="p-5 flex gap-3">
                <button
                  onClick={() => copy(image.url)}
                  className="flex-1 py-3 bg-yuzu-400 hover:bg-yuzu-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-colors"
                >
                  <Icons.Link /> 复制链接
                </button>
                <button
                  onClick={download}
                  className="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors"
                >
                  <Icons.Download /> 下载
                </button>
              </div>
            </div>
          </div>
        );
      };

      // Guest Gallery - Waterfall with infinite scroll
      const GuestGallery = ({ onImageClick, showToast }) => {
        const [images, setImages] = useState([]);
        const [loading, setLoading] = useState(true);
        const [loadingMore, setLoadingMore] = useState(false);
        const [cursor, setCursor] = useState("");
        const [hasMore, setHasMore] = useState(true);
        const loaderRef = useRef(null);

        const fetchImages = async (c = "") => {
          c ? setLoadingMore(true) : setLoading(true);
          try {
            const res = await api.getPublicImages(c, 20);
            if (res.data) {
              setImages((prev) =>
                c ? [...prev, ...res.data.items] : res.data.items
              );
              setCursor(res.data.nextCursor || "");
              setHasMore(res.data.hasMore);
            }
          } catch (e) {
            showToast("加载失败", "error");
          } finally {
            setLoading(false);
            setLoadingMore(false);
          }
        };

        useEffect(() => {
          fetchImages();
        }, []);

        useEffect(() => {
          if (!loaderRef.current || !hasMore) return;
          const observer = new IntersectionObserver(
            (entries) => {
              if (
                entries[0].isIntersecting &&
                !loadingMore &&
                hasMore &&
                cursor
              )
                fetchImages(cursor);
            },
            { threshold: 0.1 }
          );
          observer.observe(loaderRef.current);
          return () => observer.disconnect();
        }, [cursor, hasMore, loadingMore]);

        if (loading)
          return (
            <div className="flex justify-center py-20">
              <div className="w-16 h-16 border-4 border-yuzu-100 border-t-yuzu-400 rounded-full animate-spin"></div>
            </div>
          );

        return (
          <div className="w-full max-w-7xl mx-auto px-4 pb-10">
            {images.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-20 text-slate-300 border-2 border-dashed border-slate-100 rounded-3xl bg-white/30 mx-4">
                <div className="w-16 h-16 bg-white rounded-2xl shadow-card flex items-center justify-center mb-4">
                  <Icons.Gallery />
                </div>
                <p className="text-sm font-medium text-slate-400">
                  暂无公开图片
                </p>
              </div>
            ) : (
              <div className="columns-2 sm:columns-3 lg:columns-4 gap-3">
                {images.map((img) => (
                  <div
                    key={img.id}
                    className="break-inside-avoid mb-3 cursor-pointer group"
                    onClick={() => onImageClick(img)}
                  >
                    <div className="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-shadow">
                      <img
                        src={img.url}
                        className="w-full group-hover:scale-105 transition-transform duration-500"
                        loading="lazy"
                      />
                    </div>
                  </div>
                ))}
              </div>
            )}
            <div
              ref={loaderRef}
              className="h-10 flex items-center justify-center"
            >
              {loadingMore && (
                <div className="w-8 h-8 border-3 border-yuzu-100 border-t-yuzu-400 rounded-full animate-spin"></div>
              )}
            </div>
          </div>
        );
      };

      // Guest Nav - Minimal
      const GuestNav = ({ onLogin, isAuthenticated, onAdmin }) => (
        <nav className="w-full max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl overflow-hidden shadow">
              <img
                src="https://mori-pics.suimori.com/KVNheFdLRdZAZBB5p6bckVesBZYIIePF.webp"
                className="w-full h-full object-cover"
              />
            </div>
            <span className="font-bold text-xl text-slate-800 font-quicksand">
              yuzusora
            </span>
          </div>
          {isAuthenticated ? (
            <button
              onClick={onAdmin}
              className="px-4 py-2 bg-yuzu-50 border border-yuzu-200 rounded-xl text-sm font-medium text-yuzu-600 hover:bg-yuzu-100 flex items-center gap-2"
            >
              <Icons.Shield /> 管理面板
            </button>
          ) : (
            <button
              onClick={onLogin}
              className="px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-2"
            >
              <Icons.Login /> 登录
            </button>
          )}
        </nav>
      );

      // Main App
      const App = () => {
        const [authState, setAuthState] = useState("loading"); // loading, needsSetup, guest, authenticated
        const [user, setUser] = useState(null);
        const [currentPage, setCurrentPage] = useState("upload");
        const [toast, setToast] = useState(null);
        const [settingsOpen, setSettingsOpen] = useState(false);
        const [s3SettingsOpen, setS3SettingsOpen] = useState(false);
        const [loginOpen, setLoginOpen] = useState(false);
        const [guestPreview, setGuestPreview] = useState(false); // Admin viewing guest mode
        const [config, setConfig] = useState({
          compressWebp: true,
          compressQuality: 0.8,
          useOriginalFilename: false,
          defaultPublic: true,
          galleryClickCopy: true,
        });
        const [detailImage, setDetailImage] = useState(null);
        const [lightboxImage, setLightboxImage] = useState(null);

        useEffect(() => {
          const checkAuth = async () => {
            try {
              const setupRes = await api.checkSetup();
              if (setupRes.data.needsSetup) {
                setAuthState("needsSetup");
                return;
              }
              if (api.token) {
                const me = await api.getMe();
                setUser(me.data.user);
                setAuthState("authenticated");
              } else {
                setAuthState("guest"); // Default to guest mode
              }
            } catch {
              api.setToken(null);
              setAuthState("guest");
            }
          };
          const saved = localStorage.getItem("mori_upload_config");
          if (saved) setConfig((prev) => ({ ...prev, ...JSON.parse(saved) }));
          checkAuth();
        }, []);

        useEffect(() => {
          localStorage.setItem("mori_upload_config", JSON.stringify(config));
        }, [config]);

        const showToast = (msg, type = "success") => {
          setToast({ msg, type });
          setTimeout(() => setToast(null), 3000);
        };
        const handleAuth = (u) => {
          setUser(u);
          setAuthState("authenticated");
          setLoginOpen(false);
        };
        const handleLogout = () => {
          api.setToken(null);
          setUser(null);
          setAuthState("guest");
        };

        // Loading
        if (authState === "loading")
          return (
            <div className="min-h-screen flex items-center justify-center">
              <Background />
              <div className="w-16 h-16 border-4 border-yuzu-100 border-t-yuzu-400 rounded-full animate-spin"></div>
            </div>
          );

        // First time setup
        if (authState === "needsSetup")
          return (
            <>
              <Toast toast={toast} />
              <AuthPage onAuth={handleAuth} needsSetup={true} />
            </>
          );

        // Guest mode - public gallery
        if (authState === "guest" || guestPreview)
          return (
            <div className="min-h-screen">
              <Background />
              <Toast toast={toast} />
              <GuestNav
                onLogin={() => setLoginOpen(true)}
                isAuthenticated={authState === "authenticated"}
                onAdmin={() => setGuestPreview(false)}
              />
              <GuestGallery
                onImageClick={setDetailImage}
                showToast={showToast}
              />
              <ImageDetail
                image={detailImage}
                onClose={() => setDetailImage(null)}
                onZoom={setLightboxImage}
                showToast={showToast}
              />
              <Lightbox
                image={lightboxImage}
                onClose={() => setLightboxImage(null)}
              />
              {loginOpen && (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
                  <div
                    className="absolute inset-0 bg-black/50 backdrop-blur-sm"
                    onClick={() => setLoginOpen(false)}
                  ></div>
                  <div className="relative z-10 w-full max-w-md">
                    <AuthPage onAuth={handleAuth} needsSetup={false} />
                  </div>
                </div>
              )}
            </div>
          );

        // Admin mode
        return (
          <div className="min-h-screen pb-10 flex flex-col items-center">
            <Background />
            <Toast toast={toast} />
            <NavBar
              currentPage={currentPage}
              onPageChange={setCurrentPage}
              onLogout={handleLogout}
              onSettingsOpen={() => setSettingsOpen(true)}
              onS3SettingsOpen={() => setS3SettingsOpen(true)}
              onGuestPreview={() => setGuestPreview(true)}
            />
            <SettingsModal
              isOpen={settingsOpen}
              onClose={() => setSettingsOpen(false)}
              config={config}
              setConfig={setConfig}
            />
            <S3SettingsModal
              isOpen={s3SettingsOpen}
              onClose={() => setS3SettingsOpen(false)}
              showToast={showToast}
            />
            {currentPage === "upload" && (
              <UploadPage showToast={showToast} config={config} />
            )}
            {currentPage === "gallery" && (
              <GalleryPage showToast={showToast} config={config} />
            )}
            {currentPage === "stats" && <StatsPage showToast={showToast} />}
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
